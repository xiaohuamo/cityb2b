<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<title><{$lang->shopping_cart}></title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <meta name="keywords" content="" />
	<meta name="description" content="" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<link rel="stylesheet" href="<{$SKIN_PATH}>mobile/css/bootstrap.min.css" />
	<link rel="stylesheet" href="<{$SKIN_PATH}>mobile/css/style_new.css" />
    <link rel="stylesheet" type="text/css" href="<{$STATIC_PATH}>font-awesome-4.3.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="<{$SKIN_PATH}>common.css"/>
    <link rel="stylesheet" type="text/css" href="<{$SKIN_PATH}>css/orderGoods.css"/>
    <link rel="stylesheet" type="text/css" href="<{$SKIN_PATH}>css/placeOrder.css"/>
    <link rel="stylesheet" type="text/css" href="<{$SKIN_PATH}>css/datePop.css"/>
    <script src="<{$SKIN_PATH}>js/vue.min.js"></script>
    <style type="text/css">
        #geocode-result ul{
            padding: 0;
            margin: 0;
            font-size: 10px;
            list-style: none;
        }
         #geocode-result li{
            
        }
         #geocode-result label{
            
        }
         #geocode-result input{
            
        }

        .ajaxFormResponse{width: 90%;/*line-height: 20px;*/position: fixed;top: 40%;margin: auto;left: 0;right: 0;z-index: 99999;background-color:#f29230;color: #fff;padding: 25px 0px;border-radius: 15px;text-align: center;cursor: pointer;}
    </style>

    <style type="text/css">
      .well{
        background-color: #fff;
        margin: 0px;
      }
    </style>

    <style type="text/css">
      .promotion-des-display, .confirmedMoneyAppliedAmount-display{
        background-color: #FD5001 ;
        color: #fff;
        padding: 4px;
        border-radius: 5px;
      }
	  
	  
    </style>
	
	<link rel="stylesheet" type="text/css" href='<{$SKIN_PATH}>css/htmlAlert_mobile.css'>
    <script type="text/javascript" src='<{$SKIN_PATH}>js/htmlAlert.js'></script>

</head>
<body class="bg-1 bgF2F2F2">

	

	<header id="hd" style="display: none" >
	
		<div class="left">
			<a  class="a-back go-back-btn"></a>
		</div>
		<h1>
        <a href="<{$http_root_www}>member/showcart">

       
           <{$lang->shopping_cart}>ww
       

        </a>
      </h1>

          
	</header>



	  <{if $data==null}>
        <p style='position: relative;top: 100px;text-align: center;'><{$lang->nothing_in_shopping_cart}>~</p>
    <{else}>

    <{if $mixedItemFromBusinesses}>
      <div class='mixed-business-popup' style="display: none; text-align: center;position: fixed;top: 30%;z-index: 99;background: rgba(251, 194, 61, 0.8);padding: 54px;border-radius: 20px;    width: 90%;    left: 5%;">
        <i class='fa fa-close' style="position: absolute;top: 15px;right: 15px;color:#555" onClick="$(this).parent().hide();"></i>
        <span style="color:#555 "><{$lang->warning_no_multiple_store_checkout}></span>
        <br><br>
        <select class="mixed-business-select" style="    width: 99%;">
          <option value='0'><{$lang->please_choose}></option>
           <{foreach from=$data item=row}>
           <option value='<{$row.businessUserId}>'><{$row.businessUserName}></option>
          <{/foreach}>
        </select>
      </div>
    <{/if}>

    <div id="order" v-cloak class="relative">
        <div class="pTitle">
            <img src="<{$SKIN_PATH}>img/return.png" class="return" />
            下单页面
        </div><div style="height: 3rem;"></div>

    </div>

    <div class="mask z6" v-if="isDatePop">
        <div class="datePop">
            <img src="<{$SKIN_PATH}>img/cha2.png" @click="closePop('d')" class="delete"/>
            <div class="title col333 f30 bold"><{$lang->logistic_delivery_date_choose}></div>
            <div class="flexBox1" style="flex-wrap:wrap;">
                <div  class=" dateBox2 relative " v-for="(item,index) in businessDispSchedule">


                    <div class="  dateBox2selected " v-if="item.isselected" @click ="selectDeliveryDate(index)" >
                        <div class="f30 col333 pa5-0" v-if="isLanguageEn">{{item.days}}</div>
                        <div class="f30 col333 pa5-0" v-else>{{item.days_cn}}</div>
                        <div class="f25 colFD5203 pa4-0-4-0" v-if="isLanguageEn">{{item.optionalDisplay}}</div>
                        <div class="f25 colFD5203 pa4-0-4-0" v-else>{{item.optionalDisplay_cn}}</div>

                        <div class="f25 col999">{{item.disPlayDate}}</div>
                        <img src="<{$SKIN_PATH}>img/sj.png"/>
                    </div >

                    <div class="  dateBox2avaliable " v-if="!item.isselected && item.isAvaliable" @click ="selectDeliveryDate(index)">
                        <div class="f30 col333 pa5-0" v-if="isLanguageEn">{{item.days}}</div>
                        <div class="f30 col333 pa5-0" v-else>{{item.days_cn}}</div>
                        <div class="f25 colFD5203 pa4-0-4-0" v-if="isLanguageEn">{{item.optionalDisplay}}</div>
                        <div class="f25 colFD5203 pa4-0-4-0" v-else>{{item.optionalDisplay_cn}}</div>

                        <div class="f25 col999">{{item.disPlayDate}}</div>

                    </div >

                    <div v-if="!item.isselected && !item.isAvaliable">

                        <div class="f30 col333 pa5-0" v-if="isLanguageEn">{{item.days}}</div>
                        <div class="f30 col333 pa5-0" v-else>{{item.days_cn}}</div>
                        <div class="f25 colFD5203 pa4-0-4-0" v-if="isLanguageEn">{{item.optionalDisplay}}</div>
                        <div class="f25 colFD5203 pa4-0-4-0" v-else>{{item.optionalDisplay_cn}}</div>

                        <div class="f25 col999">{{item.disPlayDate}}</div>

                    </div >


                </div>
            </div>

            <div class="title col333 f30 bold" v-if="isLanguageEn">Cut time & Delivery Schedule</div>
            <div class="title col333 f30 bold" v-else>下单时间及配送时间</div>
            <div class="flexBox1 pa15-15-5-15">
                <div class="journal"  v-if="isLanguageEn">Order & Cut Time</div>
                <div class="journal"  v-else>下单截单时间</div>
                <div class="journal"  v-if="isLanguageEn">Delivery Schedule</div>
                <div class="journal"  v-else>配送日期</div>
            </div>
            <div class="pa5-15-5-15 f28 col0B0B0B">
                <div class="flexBox1 pmb15" v-for="item in orderTimeAndDeliveryTime" >
                    <span v-if="isLanguageEn">{{item.ordertime}}</span>
                    <span v-else>{{item.ordertime_cn}}</span>
                    <span v-if="isLanguageEn">{{item.delivery_date_of_week}}</span>
                    <span v-else>{{item.delivery_date_of_week_cn}}</span>
                </div>


            </div>
            <div class="continue sure"  @click="closePop('d')" >确定</div>
        </div>
    </div>
    <section id="bd" class='shopping-cart' style="display:none; padding: 0 0 0;margin-top: 45px;">
        <!-- 购物车 -->

        <div class="m-cart" style="padding-bottom: 3rem;min-height: 90vh">

             <{foreach from=$data item=row}>
            <h3 style="    margin-top: 15px;    background: beige;">
			<a href="<{$http_root_www}>member/showcart?business_userid=<{$row.businessUserId}>">
                <i class='fa fa-square-o fa-lg'></i>
                <{$row.businessUserName}>
                <i></i>
                </a>
            </h3>
            <ul class="g-ul">
                <{foreach from=$row.items item=item}>

				<a href="<{$http_root_www}>member/showcart?business_userid=<{$row.businessUserId}>">
			   <li>

                    <div class="content">
                        <div class="con">
                            <div class="pic">
                                <img src="<{$UPLOAD_PATH}><{$item.pic}>" alt="">
                            </div>

                            <span class="s-price" data-couponid='<{$item.couponid}>' data-id='<{$item.id}>'>
                               <{if $item.couponid != ''&&$item.quantity>=$item.amount}>
                                      <{if $item.quantity<$item.amount1}>
                                           <{$item.price}>
                                      <{/if}>
                                      <{if $item.quantity>=$item.amount1 && $item.quantity<$item.amount2}>
                                           <{$item.price1}>
                                      <{/if}>
                                      <{if $item.quantity>=$item.amount2}>
                                           <{$item.price2}>
                                      <{/if}>
                                 <{else}>
                                       <{$item.single_amount}>
                                 <{/if}>
                            </span>

                            <div class="txt">
                                <h4>
                                     <{if $langStr=='en'}> <{if $item.coupon_name_en}><{$item.coupon_name_en}><{else}><{$item.coupon_name}><{/if}><{else}><{$item.coupon_name}> <{/if}>

                                </h4>

                                <{if $item.bonusType=="10"}>
                                    <p><{$item.seat_des}></p>
                                <{else}>
                                     <p><{$item.guige_des}></p>
                                <{/if}>

                                <{if $item.bonusType!="10"}>
                                   <!-- 数量 -->
                                    <div class="m-num">
                                        <a class="minusBtn disabled" href="javascript:void(0);">-</a>
                                        <input class="inp shopping-cart-item-qty" type="text" value="<{$item.quantity}>" class="txt" data-limit-qty="<{$item.perCustomerLimitQuantity}>" data-maincouponid="<{$item.main_coupon_id}>"  data-subid="<{$item.sub_coupon_id}>" data-id='<{$item.id}>' data-couponid='<{$item.couponid}>' data-single-amount='<{$item.single_amount}>' data-whole-sale="<{$item.price}>" data-whole-quantity="<{$item.amount}>" data-whole-sale1="<{$item.price1}>" data-whole-quantity1="<{$item.amount1}>" data-whole-sale2="<{$item.price2}>" data-whole-quantity2="<{$item.amount2}>" readonly>
                                        <a class="plusBtn" href="javascript:void(0);">+</a>
                                    </div>
                                    <!-- 数量 -->
                                <{else}>
                                    <div class="m-num" style="display: none;">
                                        <a class="minusBtn disabled" href="javascript:void(0);" >-</a>
                                        <input class="inp shopping-cart-item-qty" type="text" value="1" class="txt"  data-id='<{$item.id}>' data-couponid='<{$item.couponid}>'  data-single-amount='<{$item.single_amount}>' data-whole-sale="<{$item.price}>" data-whole-quantity="<{$item.amount}>" data-whole-sale1="<{$item.price1}>" data-whole-quantity1="<{$item.amount1}>" data-whole-sale2="<{$item.price2}>" data-whole-quantity2="<{$item.amount2}>" readonly>
                                        <a class="plusBtn" href="javascript:void(0);" >+</a>
                                    </div>

                                    <i class='fa fa-clock-o countdownclock' style='color:green' data-action-url='<{$deleteSingleUrl}>id=<{$item.id}>'
                                    data-endtime='<{$item.createTime}>'></i>
                                <{/if}>
                            </div>
                            <i class='fa fa-close item-remove-btn fa-lg' style="position: absolute;bottom: 30px;right: 0px"></i>
                        </div>
                    </div>
                    <a href="<{$deleteSingleUrl}>id=<{$item.id}>" class="a-del"><span><{$lang->delete}></span></a>
                </li>
				</a>
                <{/foreach}>

            </ul>

            <{/foreach}>
        </div>


        <div class="order-sub order-sub-1">
		<a onClick='window.history.back();' style="left:0;" id =''><{$lang->continue_shopping}></a>
            <div class="txt">
                <p><em><{$lang->subtotal}> ： $<em id='shopping-cart-total'>0.00</em></em></p>
            </div>
            <a id ='go-checkout-btn'><{$lang->checkout}></a>
        </div>
        <!-- 购物车 end-->
	</section>
<{/if}>


<form method="post" action="<{$http_root_www}>payment/orderpaymentprocess/checkout" style ="    margin-top: 0.9rem;" class='ajaxForm'>
   <section id="bd" class='checkout-confirmation' style=' margin-top: -42px;'>

       <div class="pHead f28 col0F0F0F">
           <div class="pmb5 bold">配送日期</div>
           <div class="flexBox1">
               <span>2021年11月28日 星期6</span>
               <div class="pbtn f25 colfff" @click="datePop">修改</div>
           </div>

       </div>



        <div class="bgfff borR7 ma15 f28 col282828 ">
            <ul class="g-ul pa15">
                <li>
                    <a  class="con personal-info-btn">
                        <div class="top"><span class="f500"><{$lang->deliver_address}></span>  <em class='name-display'></em>   <span class='phone-display'></span></div>

                        <p class='address-display'></p>
                    </a>
                </li>
            </ul>
        </div>


         <div class="bgfff borR7 ma15 f28 col282828 ">
            <div class='personal-info-form  personal-info-sec well'>
                 <select class="form-control delivery_info_list_select" >
                    <option class='new' >
                        <{$lang->new_manage_address}>
                    </option>

                    <{foreach from=$delivery_info_list item=item}>
                    <option data-id='<{$item.id}>' data-first-name ='<{$item.first_name}>' data-last-name='<{$item.last_name}>' data-address='<{$item.address}>' data-phone='<{$item.phone}>' data-email='<{$item.email}>' data-Street_number='<{$item.Street_number}>' data-id-number='<{$item.id_number}>' <{if $item.isDefaultAddress}> class='defaultAddress' <{/if}> >
                         <{$item.first_name}> <{$item.last_name}> <{$item.address}>
                    </option>
                    <{/foreach}>
                </select>
                <br>
                  <div class="form-group row">
                    <label for="lastname"  style ="    font-weight: normal;margin-top: 5px;" class="col-xs-3 control-label"><{$lang->last_name}></label>
                    <div class="col-xs-9">
                      <input type="text" class="form-control new_input" id="lastname" placeholder="Last Name"  name="delivery_last_name">
                    </div>
                  </div>

                  <div class="form-group row">
                    <label for="firstname"  style ="    font-weight: normal;margin-top: 5px;" class="col-xs-3 control-label"><{$lang->first_name}></label>
                    <div class="col-xs-9">
                      <input type="text" class="form-control new_input" id="firstname" placeholder="First Name"  name="delivery_first_name" >
                    </div>
                  </div>

                  <div class="form-group row">
                    <label for="phone"  style ="    font-weight: normal;margin-top: 5px;" class="col-xs-3 control-label"><{$lang->telephone}></label>
                    <div class="col-xs-9">
                      <input type="number" class="form-control new_input" id="phone" placeholder="Phone"   name="delivery_phone">
                    </div>
                  </div>

                  <div class="form-group row">
                    <label for="email"  style ="    font-weight: normal;margin-top: 5px;" class="col-xs-3 control-label">Email<em><{$lang->optional1}></em></label>
                    <div class="col-xs-9">
                      <input type="email" class="form-control new_input" id="email" placeholder="Email"  name="delivery_email">
                    </div>
                  </div>


                  <div class="form-group row" <{if !$requireIdCard}>style="display: none;"<{/if}>>
                    <label for="email" style="    font-weight: normal;" class="col-xs-3 control-label"><{$lang->id_number}></label>
                    <div class="col-xs-9">
                      <input type="text" class="form-control new_input" id="id_number" placeholder="<{$lang->Delivery_China_needed}>"  name="id_number">
                    </div>
                  </div>

                  <div  <{if $business_delivery_info.EvoucherOrrealproduct=='evoucher'||!$business_delivery_info.deliver_enable}>style='display:none'<{/if}>>
                    <div class="form-group row">
                      <label for="address"  style ="    font-weight: normal;margin-top: 5px;" class="col-xs-3 control-label"><{$lang->address}></label>
                      <div class="col-xs-9">
                        <input type="text" class="form-control new_input" id="address" placeholder="Address" oninput="refresh()" onchange="refresh()" name="delivery_googleMap">
                      </div>
                    </div>

                    <span  style ="display:none;" class='btn btn-warning btn-sm' id ='address-validate-btn'><{$lang->verified_address}></span>
                    <div id='geocode-result'></div>

                    <div>
					  <br>
					   <input style="display:none;" type='text' id="addr_house_number" class="addr_house_number form-control" readonly="readonly" name='addr_house_number'>
					   <input style="display:none;  font-size:12px;  color: red;background: #fff;    border: 0;" type='text'  value ="<{$lang->msg_input_new_unit_number}>"  readonly="readonly" class="addr_hint99 form-control" name='addr_hint99'>
					   <input style="display:none;" type='text' id="Street_number" class="Street_number form-control new_input"  name='Street_number'>
				       <input style="display:none;"  type='text' class="addr_street form-control" readonly="readonly"  name='addr_street'>
                       <input style="display:none;"   type='text' class="addr_city form-control" readonly="readonly"  name='addr_city'>
                       <input style="display:none; "  type='text' class="addr_state form-control" readonly="readonly"  name='addr_state'>
                       <input style="display:none; "  type='text' class="addr_country form-control" readonly="readonly" name='addr_country'>
                       <input style="display:none; "  type='text' class="addr_post_code form-control" readonly="readonly"  name='addr_post_code'>
					   <input style="display:none;  font-size:12px;  color: red;" type='text'  value ="<{$lang->msg_input_new_address}>"   readonly="readonly" class="addr_hint999 form-control" name='addr_hint999'>

                    </div>

                  </div>


            </div>
        </div>



   <{if $business_delivery_info.EvoucherOrrealproduct=='realproduct' || $business_delivery_info.EvoucherOrrealproduct=='restaurant_menu'}>
       <div class="bgfff borR7 ma15 f28 col282828 ">
            <div class='order-pay' style="padding-top: 15px;    border-radius: 7px;border-bottom: 0px solid #e2e2e2;">
              <p class=' pmb5 bold f500 deliver-option-btn'><{$lang->deliver_option}>
                <a ><span class=' deliver-option-btn deliver-option-display' style='color:#0cb903'><em style="color:#f00"><{$lang->please_choose}></em></span></a>
              </p>
            </div>

             <div class="deliver-option" >
                     <div class='spec-option deliver-option-sec well' style="border:0;">
                        <div class="list-group">
                            <{if $business_delivery_info.pickup_enable}>
                               <label class="list-group-item ">
                                <h5 class="list-group-item-heading 28">
                                  <input type="radio" name="deliver_option" value="2" data-text="<{$lang->self_pickup}>" ><{$lang->self_pickup}>
                                </h5>
                              </label>
                            <{/if}>

                             <{if $business_delivery_info.deliver_enable}>
                              <label class="list-group-item ">
                                <h5 class="list-group-item-heading f28">
                                  <input checked  type="radio" name="deliver_option" value="1" data-text="<{$lang->business_deliver}>" ><{$lang->business_deliver}>
                                </h5>
                              </label>
                            <{/if}>
                        </div>

                         <{if $business_delivery_info.deliver_enable}>
                            <div class='delivery-des' style='display:none'>

                                <{if $dispCenterUserSelectedDeliveryDate}>
                                  <div>
                                    
                                        <{$lang->logistic_delivery_date}> <em><{$dispCenterUserSelectedDeliveryDate_display}></em>
                                   
                                  </div>
                               
                                <{/if}>

                                <{if $business_delivery_info.amount_for_free_delivery>0}>
                                  <strong>
                                      <label><{$lang->free_freight_amount}>:</label>
                                      <{$lang->amount_bigger_than}>$<{$business_delivery_info.amount_for_free_delivery}>
                                  </strong>
                                <{/if}>
                                
                                <{$business_delivery_info.delivery_description}>

                               <!-- <small style='color:#f30'> <{$lang->notice_deliver_fee_subject_to_condition}> </small> -->
                            </div>
                         <{/if}>

                        <{if $business_delivery_info.pickup_enable}>
                        <div class='pickup-des' style='display:none'>
                             <div class="form-group">
                              <label ><{$lang->choose_self_pickup_location}>:</label>
                              <select class="form-control pickup-list" name="business_staff_id" onchange="pickupAndDeliverExceptionCheck('pickup');">
                                 
                                <{if !$staff_list}>
                                <option value="<{$businessUser.id}>">
                                    <div ><{$businessUser.contactPersonNickName}></div>
                                    <div >:<{if $businessUser.googleMap}><{$businessUser.googleMap}><{else}><{$lang->service_scope_national}><{/if}></div>
                                    <div ><{$businessUser.contactMobile}></div>
                                </option>
                                <{/if}>
                               

                                <{foreach from=$staff_list item=item}>
                                <option value="<{$item.id}>">
                                    <div ><{$item.contactPersonNickName}></div>
                                    <div >:<{if $item.googleMap}><{$item.googleMap}><{else}><{$lang->service_scope_national}><{/if}></div>
                                    <div ><{$item.contactMobile}></div>
                                </option>
                                <{/foreach}>
                              </select>
                              </div>    

                            <{$business_delivery_info.pickup_des}>
							 
                        </div>
                        <{/if}>
						  <input  name="dispCenterUserSelectedDeliveryDate" type="hidden"  value="<{$dispCenterUserSelectedDeliveryDate}>"  />
                    </div>
            </div>
           </div>

            <{elseif $business_delivery_info.EvoucherOrrealproduct=='evoucher'}>
            <div class='order-pay'>
              <p style="display: none"><{$lang->deliver_option}>
                <a ><span class='deliver-option-display' style='color:#0cb903'><{$lang->no_need_delivery}></span></a>
              </p>
               <input type="hidden" name="deliver_option" value="0" style="display: none"   >
             </div>
            <{/if}>


       <div class="bgfff borR7 ma15 f28 col282828 ">


        <div class="order-pay" style="padding-top: 15px;    border-radius: 7px;border-bottom: 0px solid #e2e2e2;">
            <p class=' pmb5 bold f500  payment-option-btn'><{$lang->payment_option}>
              <a ><span class='payment-option-display' style='color:#0cb903'><em style='color:#f00'><{$lang->please_choose}></em></span></a>
            </p>
        </div>

             <div class=" payment-option" >
                   <div class='spec-option  payment-option-sec well'>
                    <div class="list-group">
                      <{if $business_delivery_info.supportofflinepayment=='supportofflinepayment'}>
                       <label  class="list-group-item ">
                       
                        <h5 class="list-group-item-heading f28">
                            <input type="radio" name="payment" value="offline" data-text="<{$lang->pay_offline}>" ><{$lang->pay_offline}>
                        </h5>
                      </label>
                      <{/if}>

                       <{if $business_delivery_info.supportroyalpaypayment=='supportroyalpaypayment'}>
                          <label  class="list-group-item ">
                            <h5 class="list-group-item-heading f28">
                                <input type="radio" name="payment" value="royalpay" data-text="<{$lang->pay_wechat}>" ><{$lang->pay_wechat}>
                            </h5>
                          </label>

                           <label  class="list-group-item ">
                            <h5 class="list-group-item-heading f28">
                                <input type="radio" name="payment" value="alipay" data-text="<{$lang->Alipay}>" >
                                <{$lang->Alipay}>
                            </h5>
                          </label>
                        <{/if}>
<!--
                       <{if $business_delivery_info.supportpaypalpayment=='supportpaypalpayment'}>
                      <label  class="list-group-item ">
                        <h5 class="list-group-item-heading">
                            <input type="radio" name="payment" value="paypal" data-text="<{$lang->pay_paypal}>" >
                            <{$lang->pay_paypal}>
                        </h5>
                      </label>
                      <{/if}>
-->
                       <{if $business_delivery_info.supporthcashpayment=='supporthcashpayment'}>
                           <label  class="list-group-item ">
                            <h5 class="list-group-item-heading f28">
                                <input type="radio" name="payment" value="hcash" data-text="<{$lang->pay_hcahs}>" > <{$lang->pay_hcahs}>
                            </h5>
                          </label>
                        <{/if}>
                      
                        <{if $business_delivery_info.supportcreditcardpayment=='supportcreditcardpayment'}>
                           <label  class="list-group-item ">
                            <h5 class="list-group-item-heading f28">
                                <input type="radio" name="payment" value="creditcard" data-text="<{$lang->pay_creditcard}>" ><{$lang->pay_creditcard}>
                            </h5>
                          </label>
                        <{/if}>

                    </div>

                    <div class='offline-payment-des payment-option-desc f28' style='display:none'>
                      <{$lang->pay_offline_desc}>
                      <br>
                  <!--    <{$business_delivery_info.offline_pay_des}> -->
                    </div>

                    <div class='paypal-payment-des payment-option-desc f28' style='display:none'>
                      <{$lang->notice_paypal_pay_desc}>
                    </div>

                    <div class='royalpay-payment-des payment-option-desc f28' style='display:none'>
                      <{$lang->notic_wechat_pay_desc}>
                    </div>

                    <div class='alipay-payment-des payment-option-desc f28' style='display:none'>
                      <{$lang->notic_alipay_desc}>
                    </div>

                    <div class='hcash-payment-des payment-option-desc f28' style='display:none'>
                      <{$lang->notice_hcash_pay_desc}>
                    </div>

                    <div class='creditcard-payment-des payment-option-desc f28' style='display:none'>
                   
                      	
    <div class="txt content-image-fullsize" style="display: block; color:red;font-weight: 800;">  <{$lang->notice_creditcard_pay_desc}> <{$lang->credit_card_notice}> 
                      <div class='creditcard-payment-des form-group'>
                        <!-- CREDIT CARD FORM STARTS HERE -->
                        <div class="panel panel-default credit-card-box">
                            <div class="panel-heading display-table" >
                                <div class="row display-tr" >
                                    <h3 class="panel-title display-td f28" ><{$lang->pay_creditcard}></h3>
                                    <div class="display-td" >                            
                                        <img class="img-responsive pull-right" src="<{$SKIN_PATH}>images/accepted_card.png">
                                    </div>
                                </div>                    
                            </div>
                            <div class="panel-body">
                                     <{if $card_on_file}>
                                      <div>
                                          <span>Use Card On File </span>
                                          &nbsp;&nbsp;&nbsp;&nbsp;
                                          <input name='use_card_on_file' type="checkbox" id ='use_card_on_file' >
                                          <label style='display: inline' for='use_card_on_file'><{$card_on_file}></label>
                                      </div>
                                      <hr>
                                    <{/if}>

                                    <div class="row">
                                        <div class="col-xs-12">
                                            <div class="form-group">
                                                <label for="cardNumber">CARD NUMBER</label>
                                                <div class="input-group">
                                                    <input  type="tel" class="form-control" name="card_number" placeholder="Valid Card Number" autocomplete="cc-number"
                                                    />
                                                    <span class="input-group-addon"><i class="fa fa-credit-card"></i></span>
                                                </div>
                                            </div>                            
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-xs-4 col-md-4">
                                            <div class="form-group">
                                                <label for="cardExpiry"> MM</label>
                                                <select  class="form-control" name='card_expire_month'>
                                                  <{for $m=1 to 9}>
                                                    <option value="<{$m}>">0<{$m}></option>
                                                  <{/for}>
                                                    <option value="10">10</option>
                                                    <option value="11">11</option>
                                                    <option value="12">12</option>
                                                </select>
                                            </div>
                                        </div>

                                         <div class="col-xs-4 col-md-4">
                                            <div class="form-group">
                                                <label for="cardExpiry"> YY</label>
                                                <select  class="form-control" name='card_expire_year'>
                                                  <{for $y=16 to 46}>
                                                    <option value="<{$y}>"><{$y}></option>
                                                  <{/for}>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="col-xs-4 col-md-4 pull-right">
                                            <div class="form-group">
                                                <label for="cardCVC">CV CODE</label>
                                                <input  type="tel"  class="form-control" name="card_security_code" placeholder="CVC" autocomplete="cc-csc"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                   
                            </div>
                        </div>        

                        <style type="text/css">
                          /* CSS for Credit Card Payment form */
                          .credit-card-box .panel-title {
                              display: inline;
                              font-weight: bold;
                          }
                          .credit-card-box .form-control.error {
                              border-color: red;
                              outline: 0;
                              box-shadow: inset 0 1px 1px rgba(0,0,0,0.075),0 0 8px rgba(255,0,0,0.6);
                          }
                          .credit-card-box label.error {
                            font-weight: bold;
                            color: red;
                            padding: 2px 8px;
                            margin-top: 2px;
                          }
                          .credit-card-box .payment-errors {
                            font-weight: bold;
                            color: red;
                            padding: 2px 8px;
                            margin-top: 2px;
                          }
                          .credit-card-box label {
                              display: block;
                          }
                          /* The old "center div vertically" hack */
                          .credit-card-box .display-table {
                              display: table;
                          }
                          .credit-card-box .display-tr {
                              display: table-row;
                          }
                          .credit-card-box .display-td {
                              display: table-cell;
                              vertical-align: middle;
                              width: 50%;
                          }
                        </style>    
                        <!-- CREDIT CARD FORM ENDS HERE -->
                    </div>

                    </div>
                </div>
            </div>


             </div>

       </div>

       <{if $promotion}>
             <div class="bgfff borR7 ma15 f28 col282828 ">




                 <div class="order-pay" style="    padding-top: 10px;    border-radius: 7px;    border-bottom: 0px solid #e2e2e2;    padding-bottom: 10px;">
                          <p class=' pmb5 bold coupon-option-btn'><{$lang->enter_promotion_code}>
                            <a ><span class='promotion-des-display pbtn f25 colfff'><{$lang->not_applied}></span></a>

                          </p>
                        </div>
                   </div>
        <{/if}>

            <{if $moneyBalance>0}>
               <div class="bgfff borR7 ma15 f28 col282828 ">
                   <div class="order-pay" style="    padding-top: 10px;    border-radius: 7px;    border-bottom: 0px solid #e2e2e2;    padding-bottom: 10px;">
                   <p class='pmb5 bold  use-money-btn'><{$lang->wallet}>
                        <a > <span class='confirmedMoneyAppliedAmount-display  pbtn f25 colfff'><{$lang->not_applied}></span></a>
                      </p>
                    </div>
               </div>
            <{/if}>


       <div class="bgfff borR7 ma15 f28 col282828 ">

           <div class="order-pay" style="    padding-top: 10px;    border-radius: 7px;    border-bottom: 0px solid #e2e2e2;    padding-bottom: 10px;">
               <p class="pmb5 bold  use-money-btn">购物清单

               </p>
           </div>

         <div class="order-info order-info-1">
            <ul class="g-ul m-list2">
		
		  <{foreach from=$data item=row}>
		   <li>
              <div class="con"> <{$row.businessUserName}> </div>

		   </li>
		
             <{foreach from=$row.items item=item}>
                <li>
                    <div class="pic">
                    <img src="<{$UPLOAD_PATH}><{$item.pic}>" alt="">
                        <{if $item.bonusType=="10"}>
                            <i class='fa fa-clock-o countdownclock' style='color:green;position: relative;top: 7px' data-endtime='<{$item.createTime}>' data-action-url='<{$deleteSingleUrl}>id=<{$item.id}>'></i>
                        <{/if}>
                    </div>
                    <div class="con">
                        <h4 style="white-space: normal;"> <{if $langStr=='en'}> <{if $item.coupon_name_en}><{$item.coupon_name_en}><{else}><{$item.coupon_name}><{/if}><{else}><{$item.coupon_name}> <{/if}>
											</h4>

                        <{if $item.bonusType=="10"}>
                            <span><{$lang->seats}><{$item.seat_des}></span>
                            <input  name="seat_des[]" type="hidden"  value="<{$item.seat_des}>"  />
                            <input  name="seat_id[]" type="hidden"  value="<{$item.seat_id}>"  />
                        <{else}>
                            <span><{if $item.guige_des}><{$lang->specification}>:<{$item.guige_des}><{/if}></span>
                            <input  name="guige_des[]" type="hidden"  value="<{$item.guige_des}>"  />
                            <input  name="guige_ids[]" type="hidden"  value="<{$item.guige_ids}>"  />
                        <{/if}>

                        <span class="s-price" data-couponid='<{$item.couponid}>'  data-id='<{$item.id}>'>
                               <{if $item.couponid != ''&&$item.quantity>=$item.amount}>
                                      <{if $item.quantity<$item.amount1}>
                                           <{$item.price}>
                                      <{/if}>
                                      <{if $item.quantity>=$item.amount1 && $item.quantity<$item.amount2}>
                                           <{$item.price1}>
                                      <{/if}>
                                      <{if $item.quantity>=$item.amount2}>
                                           <{$item.price2}>
                                      <{/if}>
                                 <{else}>
                                       <{$item.single_amount}>
                                 <{/if}>
                            </span>

                          <p class='pickupAndDeliverExceptionCheck' 
                            data-pickup-avaliable='<{$item.pickup_avaliable}>'
                            data-deliver-avaliable='<{$item.deliver_avaliable}>'
                            data-type='<{$item.EvoucherOrrealproduct}>'
                            data-item-it='<{$item.id}>'
                            data-sales-user-list='<{$item.sales_user_list}>'
                            >
                            </p>

                    </div>
                    <em class="num">x <input name="quantity[]" class='checkout-confirmation-qty' data-couponid='<{$item.couponid}>' data-id='<{$item.id}>' value='' readonly style='width: 30px;border:none;background: none'></em>
                </li>

                <input type="hidden" name="ids[]" value="<{$item.id}>" />
                <input type="hidden" name="main_ids[]" value="<{$item.main_coupon_id}>" />
                <input type="hidden" name="sub_ids[]" value="<{$item.sub_coupon_id}>" />
                <input type="hidden" name="sub_or_main[]" value="<{$item.sub_or_main}>" />
                <input type="hidden" name="coupon_names[]" value="<{$item.coupon_name}>" />
                <input type="hidden" name="single_amount[]"  value="<{$item.single_amount}>"/>
                <input type="hidden" name="original_amount[]"  value="<{$item.original_amount}>"/>
                <input type="hidden" name="commission_free[]"  value="<{$item.commission_free && $item.onSpecial}>"/>

                <input type="hidden" name="menu_id[]" value="<{$item.menu_id}>" />
                <input type="hidden" name="sidedish_menu_id[]"  value="<{$item.sidedish_menu_id}>"/> 
                     <{/foreach}>
             <{/foreach}>

            <input type="hidden" name="business_userId" value="<{$businessUser.id}>" />
            <input type="hidden"  id ="total_amount" name="total_amount" class="input-text"  value="0" /> 
            <input type="hidden"  id ="booking_total"  name="booking_total" class="input-text"  value="0" /> 
            <input type="hidden"  id ="delivery_fee"  name="delivery_fee" class="input-text"  value="0"  /> 
            <input type="hidden"  id ="promotion_total" name="promotion_total" class="input-text"  value="0" /> 
            <input type="hidden"  id ="promotion_id" name="promotion_id" class="input-text"  value="0"  /> 
            <input type="hidden"  id ="confirmedMoneyAppliedAmount" name="confirmedMoneyAppliedAmount" class="input-text"  value="0"  /> 
            <input type="hidden"  id ="total_amount_inc_delivery_fees" name="total_amount_inc_delivery_fees" class="input-text"  value="0" /> 
            <input type="hidden"  id ="surcharge" name="surcharge" class="input-text"  value="0" />
            <input type="hidden"  id ="factory_id" name="factory_id" class="input-text"  value="<{$factory_id}>" />

                <input type="hidden"  id ="specialGroupPinCheckoutUserGroupId" name="specialGroupPinCheckoutUserGroupId" value="<{$specialGroupPinCheckoutUserGroupId}>" />
               
            </ul>
            <div class="words f28 col303134 pinfoBox" style="    padding-bottom: 30px;">
                <div>
                    <span><{$lang->product_total}>:<em id = 'checkout-confirmation-total'></em></span>
                    <b style='display:block' class='deliver-fee-display'></b>  
                    <b style='display:block' class='deliver-fee-display-msg'></b>  
                    <b style='display:block' class='booking-fee-display'></b> 
                    <b style='display:block' class='promotion-amount-display'></b>
                    <b style='display:block' class='use-money-display'></b>
                    <b style='display:block;border-bottom: 1px solid #555'></b>
                    <b style='display:block' class='total-before-surcharge'></b>
                    <b style='display:block' class='surcharge-display'></b>
                </div>
                
                <input type="text" class="g-input" placeholder="<{$lang->messages_to_business}>" name="message_to_business">

            </div>
        </div>

       </div>
        <div class="h2"></div>



       <div class="flexBox1 fixBottom"><div class="flexBox1"><span class="col303134 f28 bold"><{$lang->total_amount}></span>&nbsp;&nbsp;
           <div><span class="f38 colFD5001 bold">$</span><span class="bold colFD5001 f38 grand-total-display"></span></div></div>
           <div class="flexBox1 "><div onclick="window.location.href='<{$http_root_www}>supplier/<{$businessUser.id}>'" class="pbtn f28 colFD590E againBtn "><{$lang->continue_shopping}></div>&nbsp;&nbsp;
           <div class="ajaxFormSubmitBtn pbtn f28 colfff"><{$lang->submit_order}></div></div></div>


<!--
        <div class="order-sub">
		
		<{if !$freshfood}>
		<a onClick='window.history.back();' style="left:0;" id =''><{$lang->continue_shopping}></a>
		<{else}>
		<a href='<{$http_root_www}>restaurant/<{$freshfood}>?cart=1&dy=<{$dy}>' style="left:0;" id =''><{$lang->update}></a>
		<{/if}>
            <div class="txt">
                <p><{$lang->total_amount}> : <em> $<em class='grand-total-display'></em> </em></p>
                <span><{$lang->final_amount_to_pay}></span>
            </div>
            <a class='ajaxFormSubmitBtn'><span><{$lang->submit_order}></span></a>
        </div>
-->
    </section>

        </div>
   
     <div class="pop-spec coupon-option" style="padding-bottom: 50px;">
        <span class="spec-close"></span>

        <div class='coupon-check pop-content'>
            <h4><{$lang->apply}><{$lang->promotion_code}></h4>

            <div  id="verified_image" style="    text-align: center;   display: none;   padding-bottom: 35px;">
                <img  src="<{$SKIN_PATH}>img/success2.png" style="      width: 50px; ">
            </div>

            <p class="promotion-loading bold f35 text" style="    text-align: center;"></p>
             <hr>
            <div class="input-group">
			
			
			
		<{if !$promotion_code_list}>
			
          <input type="text" class="H80" id ="promotion_code" name="promotion_code" placeholder="<{$lang->promotion_code}>" style="    width: calc(100% - 1rem);">
			  
			<{else}>    
			  <select class="form-control "  id ="promotion_code" name="promotion_code"  >
			   <{foreach from=$promotion_code_list item=item}>
                     <option  value ="<{$item.promotion_code}>" selected="selected">
                       <{$item.promotion_des}>-$<{$item.value}>优惠券 
                    </option>
                   
              
			   <{/foreach}> </select>
		  <{/if}>
			  
              <span class="input-group-btn">
                <div class=" pbtn f25 colfff " type="button" onClick="check_promotion_code();", style="background-color: #FD5001 ; color: #fff; margin-left: 10px;"><{$lang->apply}></div>

              </span>
			  
			  
			
			  			  
			  
			  
			  
			  
            </div>
            <hr>
            <p><{$lang->promotion_code_desc}></p>     
        </div>

    <!--    <a  class="spec-btn"><{$lang->confirm}></a> -->

    </div>

    <{if $moneyBalance>0}>


    <div class="pop-spec use-money-option" style="padding-bottom: 50px;" >
        <span class="spec-close"></span>

        <div class='use-money pop-content'>
            <h4><{$lang->spend_fund}></h4>
            <p class="money-loading"> <{$lang->available_fund_desc}>：$<{$moneyBalance}></p>
            <p class='use-money-error'></p>
            

                <hr>
               <div class="input-group">
                  <span class="input-group-addon" style="    border-right: 1;    border: 0px solid #ccc;">$</span>
                   <input type="text" class=" H80" aria-label="Amount (to the nearest dollar)" id="amountApply" name="amountApply" data-available-amount='<{$moneyBalance}>' placeholder="0" style="    width: calc(100% - 2rem);   ">
                   <span class="input-group-btn">

                 <div class=" pbtn f25 colfff " type="button"onClick="applyPocketMoney();" ,="" style="background-color: #FD5001 ; color: #fff; margin-left: 10px;"><{$lang->spend_fund}></div>
                  </span>
                </div>   
                 <hr>
            <p><{$lang->available_fund_desc}></p>    
        </div>
        </div>
    <!--    <a class="spec-btn"><{$lang->confirm}></a> -->

    <{/if}>
    <div class="pop-bg"></div>
    <!-- 选择类型弹窗-end -->


</form>


	<script type="text/javascript" src="<{$SKIN_PATH}>mobile/js/jquery.js"></script>
	<script type="text/javascript" src="<{$SKIN_PATH}>mobile/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="<{$SKIN_PATH}>mobile/js/lib.js"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbjX3k87CvBY7S1RH5dEcjCehRwbjXzi4&libraries=places"></script>
    <script src="<{$STATIC_PATH}>geocomplete/jquery.geocomplete.js"></script>

     <script type="text/javascript">
         $(function(){
            try {
                initGeocomplete();
            }
            catch(err) {
                console.log('google API not working. ');
            }
          });

          function initGeocomplete(){
             $("#address").geocomplete()
            .bind("geocode:result", function(event, result){
                populateHiddenAddrInput(result);
                $('.address-display').text($('input#address').val());
            })
            .bind("geocode:error", function(event, status){
              console.log("ERROR: " + status);
            })
            .bind("geocode:multiple", function(event, results){
                geocodeResultDisplay(results);
            });
          }

          $(function(){
             $("#address-validate-btn").click(function(){
              $("#address").trigger("geocode");
            });

              $('body').on('click','#geocode-result input',function(){
                 $("#address").val($(this).val());
             });
              
          })

          function geocodeResultDisplay(result) {
            console.log(result);
            var html = " <ul>"

            for (var i = result.length - 1; i >= 0; i--) {
              var r = result[i].formatted_address;
              html+="<li><label><input type='radio' name='geocode-result-list' value='"+r+"'>"+r+"<label></li>"
            }
             html+= " </ul>"

            $('#geocode-result').html(html);
          }

          function populateHiddenAddrInput(result) {
            var parts = result.address_components;
			var postcode='';
            
            for (var i = parts.length - 1; i >= 0; i--) {
              if (parts[i].types.includes('street_number')) {
                $(".addr_house_number").val(parts[i].short_name);
				//$(".addr_house_number").css('display',''); 
             
			  
			/*  if( !$(".Street_number").val()) {
			     $(".Street_number").val(parts[i].short_name);
			  } */
			   }
              if (parts[i].types.includes('route')) {
                $(".addr_street").val(parts[i].short_name);
			//	$(".addr_street").css('display',''); 
              }
              if (parts[i].types.includes('locality')) {
                $(".addr_city").val(parts[i].short_name);
			//	$(".addr_city").css('display',''); 
              }
              if (parts[i].types.includes('administrative_area_level_1')) {
                $(".addr_state").val(parts[i].short_name);
			//	$(".addr_state").css('display',''); 
				
              }
              if (parts[i].types.includes('country')) {
                $(".addr_country").val(parts[i].short_name);
			//	$(".addr_country").css('display',''); 
				
              }
              if (parts[i].types.includes('postal_code')) {
                $(".addr_post_code").val(parts[i].short_name);
			//	$(".addr_post_code").css('display',''); 
				postcode = parts[i].short_name;
				if (postcode.substr(0,1) !=3) {
				  alert('<{$lang->address_out_of_vic}>');
				}else{
				  //判断用于邮编是否在区域内，如果不再，提示不能下单。
				var postcodes ='<{$avaliable_postcodes}>';
				if(postcodes.length>=4) {
				if( postcodes.indexOf(postcode)!=-1){
					//alert("包含");
				}else{
					alert("<{$lang->out_of_delivery_range}>");
				}
               }
				 // alert('维州地区邮编，支持');
				}
				
				
				
              }
			  $(".addr_hint99").css('display',''); 
			  
			  $(".Street_number").css('display',''); 
			  
			  
			  
            }
			updateDeliverFee();
			//alert('here1');
          }
      </script>


    <script type="text/javascript">
        var total=0;
        var grandTotal=0;
        var grandTotal_beforeSurcharge=0;

        var deliverFee=0;
		var distance=0;
        var deliverFeeEnable=false;

        var bookingFee=0;
        // var promotion_amount;
        // var confirmedMoneyAppliedAmount;

        var currentPaymentMethod;
        var surchargevalue;
        var surchargeRate={};
         
         
        <{if $business_delivery_info.transactionFeeChargeFrom_paypal!='user'}>
          surchargeRate['paypal']=0;
        <{else}>
          surchargeRate['paypal']=parseFloat('<{$business_delivery_info.paypalsurcharge}>');
        <{/if}>


        <{if $business_delivery_info.transactionFeeChargeFrom_royalpay!='user'}>
          surchargeRate['royalpay']=0;
        <{else}>
          surchargeRate['royalpay']=parseFloat('<{$business_delivery_info.royalpaysurcharge}>');
        <{/if}>

        //alipay use same config as royalpay(wechat)
         <{if $business_delivery_info.transactionFeeChargeFrom_royalpay!='user'}>
          surchargeRate['alipay']=0;
        <{else}>
          surchargeRate['alipay']=parseFloat('<{$business_delivery_info.royalpaysurcharge}>');
        <{/if}>


        <{if $business_delivery_info.transactionFeeChargeFrom_hcash!='user'}>
          surchargeRate['hcash']=0;
        <{else}>
          surchargeRate['hcash']=parseFloat('<{$business_delivery_info.hcashsurcharge}>');
        <{/if}>
        

        <{if $business_delivery_info.transactionFeeChargeFrom_creditcard!='user'}>
          surchargeRate['creditcard']=0;
        <{else}>
          surchargeRate['creditcard']=parseFloat('<{$business_delivery_info.creditcardsurcharge}>');
        <{/if}>

       function calculateTotal(){
          total = 0;
          totalQty= 0;


    			var old_couponid = 0;
    			var new_couponid = 0;
    			var qty_of_same_coupon =0;
    			var amount_of_same_coupon=0;
    			var addup =0; //标记在叠加中，如果在叠加中循环，当前条目的数据没有被处理，在下一条中判断是否处理，如果叠加是最后一条记录，则会通过

    			var i=0;

    			var sub_total_array = [];
			
		
            $('.shopping-cart-item-qty').each(function(){
			
			   	     //获取批发数据 
				        var price=parseFloat($(this).data('whole-sale'));//通过price判断是否有批发属性 第一级
                var quantity=parseFloat($(this).data('whole-quantity'));//批发预设数量 第一级

                var price1=parseFloat($(this).data('whole-sale1'));//通过price判断是否有批发属性 第二级
                var quantity1=parseFloat($(this).data('whole-quantity1'));//批发预设数量 第二级

                var price2=parseFloat($(this).data('whole-sale2'));//通过price判断是否有批发属性 第三级
                var quantity2=parseFloat($(this).data('whole-quantity2'));//批发预设数量 第三级

                var amount="";//单价
                var qty = parseFloat($(this).val());//当前数量
			    
                var item_id = parseFloat($(this).data('id'));
                var single_amount = parseFloat($(this).data('single-amount'));
			
			          new_couponid = parseInt($(this).data('couponid'));

                if (price){
                    if(!price1){
                        price1 =price;
                    }
                    if(!price2){
                        price2 =price1;
                    }
                    if(!quantity){
                        quantity=qty;
                    }
                    if(!quantity1){
                        quantity1 =quantity;
                    }

                    if(!quantity2){
                        quantity2 =quantity1;
                    }

                }
				
             
            				if(new_couponid ) { //新条目有批发属性
                				  if(new_couponid != old_couponid){ // 如果新的couponid 和之前的产品不一一样，
                                if( old_couponid ==0) {  // 如果之前的产品与批发无关，表明当前条目为一个新的批发，开始进行数量累加及批发价格计算。
                                    addup =1; //批发累加进行中
                                    qty_of_same_coupon +=qty;//数量累加
                                    //计算批发价格
                                    amount_of_same_coupon=getItemAmount(single_amount,price,price1,price2,qty_of_same_coupon,quantity,quantity1,quantity2);
                                    // 将当前条目标识及数量退入数组，当累加结束后，使用数组元素进行显示对应条目的价格和子汇总，批发未结束价格无法最终确定
                                    //sub_total_array.push([item_id,qty]); //subtotal 数组中加入 当前条目编号，及数量
                                }else{ //如果之前的产品与批发相关，且当前产品和之前的不同，则做两个处理：
                                    // 1）将之前的产品进行价格计算，进入汇总，并显示。
                                    priceAndSubAndTotalDisplay(qty_of_same_coupon,amount_of_same_coupon,old_couponid);						
                                    //sub_total_array = [];
                                    				
                                    // 对新的批发条目进行累计开始
                                    qty_of_same_coupon =qty;	
                                    //alert('price is :' + price + ' price1:' + price1 + ' price2' + price2 + ' qty_of_same_coupon' + qty_of_same_coupon + ' quantity'+ quantity + ' quantity1' + quantity1 + ' quantity2' + quantity2);
                                    amount_of_same_coupon=getItemAmount(single_amount,price,price1,price2,qty_of_same_coupon,quantity,quantity1,quantity2);
                                    //sub_total_array.push([item_id,qty]);
                                    addup =1;
                                    //alert('qty' + qty_of_same_coupon +' amount ' + amount_of_same_coupon );
                    					 }
                					
                				  }else{
                				   //如果新的和就得相同则只进行叠加
                				   qty_of_same_coupon +=qty;
                				   amount_of_same_coupon=getItemAmount(single_amount,price,price1,price2,qty_of_same_coupon,quantity,quantity1,quantity2);
                				   //sub_total_array.push([item_id,qty]);
                				   addup =1;
                				  }
                				
            				}else{
            				    //如果新条目不是批发new_couponid==0 
            					if(old_couponid >0){//但旧条目是批发 old_couponid>0 ，那么旧条目的同规格累计结束，就要进行最后的统计，并复位数量=0
            						priceAndSubAndTotalDisplay(qty_of_same_coupon,amount_of_same_coupon,old_couponid);
            						//sub_total_array = [];//数组清空
            						qty_of_same_coupon=0;// 复位数量
            						addup =0; //将叠加标识清0；
            					}
            				
            					// 如果新的couponid==0 表示当前的条目跟批发无关，则直接累计入当前合计中。
            					new_couponid =0;
            					addup=0;
            					amount = parseFloat($(this).data('single-amount'));
            					total += qty * amount;
                      totalQty += qty; 
            					$('.unit[data-id="'+$(this).data('id') +'"]').html(amount);
            				}
            				
            				old_couponid =new_couponid;
              
            });
			
			
      			//如果叠加参数为1，那么需要进行最后的计算 //数组清空  // 复位数量  //将叠加标识清0；
      			if(addup ==1){
      			   	priceAndSubAndTotalDisplay(qty_of_same_coupon,amount_of_same_coupon,old_couponid);
      				//sub_total_array = [];
      				qty_of_same_coupon=0;
      				addup =0;
      			}
			
            updataDisplay('total');
        }
     
	 // 获取当前行累计的多级价格计算的价格--通过检查同种商品的总数量，来检查相应数量对应的价格，并返回结果
	  function getItemAmount(single_amount,price,price1,price2,qty_of_same_coupon,quantity,quantity1,quantity2){
		
		  if(price!=''&& qty_of_same_coupon>=quantity){
						if ( qty_of_same_coupon<quantity1)
							amount=price;

						if (qty_of_same_coupon>=quantity1 && qty_of_same_coupon<quantity2)
							amount=price1;

						if (qty_of_same_coupon>=quantity2)
							amount=price2;

		  } else {
		  	 amount = single_amount;
	    }
					 
			return amount;
		}

	 //购物车多级价格价格计算更新及显示处理，包括子汇总计算及显示和总汇总计算（数量和总金额）
		function  priceAndSubAndTotalDisplay(qty,amount,couponid){
        total += qty * amount;
        totalQty += qty;
        $('.s-price[data-couponid="'+couponid +'"]').html(amount.toFixed(2));
		}
		
    
        function calculateBookingFee(){
            bookingFee = 0;

            var rate = parseFloat('<{$bookingfee}>');
            var type = '<{$bookingfeetype}>';

            if(type=='peritem'){
                $('.shopping-cart-item-qty').each(function(){
                    var qty = parseFloat($(this).val());
                    bookingFee += qty * rate;
                });
            }else{
                bookingFee=rate;
            }
            
        }

         function calculateSurcharge(){
            if(currentPaymentMethod&&currentPaymentMethod!='offline'){

              surchargevalue = (total + deliverFee + bookingFee - promotion_amount - confirmedMoneyAppliedAmount) * surchargeRate[currentPaymentMethod];
              
            }else{
              surchargevalue=0;
            }

            if(surchargevalue<0)surchargevalue=0;
        }

        function calculateDeliverFee(){
            if(deliverFeeEnable){
               
            }else{
                deliverFee = 0;
            }
            
        }

        function updateDeliverFee(){
            var address = $("input#address").val();
            //alert(address);
		   //alert(<{$processingBusinessUserId}>);
            $.ajax({
                method: "get",
                url: "<{$http_root_www}>query?cmd=calculate_deliver_fee",
                data: { id: '<{$processingBusinessUserId}>',address:address},
                beforeSend:function(){
                    $('body').append('<p class="form_response_loader"></p>');
                },
                success:function(result){
                    try{
                        result=JSON.parse(result);

                        deliverFee = parseFloat(result.total_deliver_fee);
						distance = parseInt(result.distance);
                        if(deliverFee>=9900) {
						  alert('超出配送距离，请下单前咨询客服是否可以送达！');
						}
                        if(result.msg)
                          $('.deliver-fee-display-msg').html('运费('+result.distance+'km '+result.msg+'):<em>+'+deliverFee.toFixed(2)+'</em>');
                        else
                          $('.deliver-fee-display-msg').html(" ");
                       
                    }catch(err){
                        deliverFee=0;
                    }

                     refresh();

                },
                complete:function(){
                    $('.form_response_loader').remove();
                },
                error:function(result){
                    
                }
              })
        }

        function  calculatePromotion(){
            var totalBeforePromotionCode = total + deliverFee + bookingFee - confirmedMoneyAppliedAmount;
            if(totalBeforePromotionCode<promotion_amount)
              promotion_amount=totalBeforePromotionCode;
        }

        function calculateGrandTotal(){
            grandTotal = total + deliverFee + bookingFee - promotion_amount - confirmedMoneyAppliedAmount + surchargevalue;
            if(grandTotal<0)grandTotal=0;

            grandTotal_beforeSurcharge = total + deliverFee + bookingFee - promotion_amount - confirmedMoneyAppliedAmount;
            if(grandTotal_beforeSurcharge<0)grandTotal_beforeSurcharge=0;
        }

        function updataDisplay($target){

            switch($target){
                case 'total':
                    $('#shopping-cart-total').text(total.toFixed(2));
                    $('#checkout-confirmation-total').text(total.toFixed(2));
                    break;
                case 'grand-total':
                    $('.grand-total-display').text(grandTotal.toFixed(2));
                    break;
                case 'booking-fee':
                    if(bookingFee>0)
                        $('.booking-fee-display').html("<{$lang->booking_fee}>:<em>+"+bookingFee.toFixed(2)+"</em>");
                    break;
                case 'deliver-fee':
                    if(deliverFee>0)
					  if(distance>0) {
					   $('.deliver-fee-display').html('<{$lang->deliver_fee}>'+'(<{$lang->deliver_distance}>:'+distance+'KM)' +':<em>+'+deliverFee.toFixed(2)+'</em>');
					  }else{
					   $('.deliver-fee-display').html('<{$lang->deliver_fee}>:<em>+'+deliverFee.toFixed(2)+'</em>');
					  }
                       
                    else
                        $('.deliver-fee-display').html('');
                    break;
                case 'personal-info':
                    $('.name-display').text($('input#firstname').val()+" "+$('input#lastname').val());
                    $('.phone-display').text($('input#phone').val());
                    $('.address-display').text($('input#address').val());
                    break;
                case 'promotion-code':
                    if(promotion_amount<=0){
                        $('.promotion-amount-display').html('');
                        $('.promotion-des-display').text('<{$lang->not_applied}>');
                    }else{
                        $('.promotion-des-display').text(promotion_des);
                        $('.promotion-amount-display').html("<{$lang->promotion_code}>:<em>-"+promotion_amount.toFixed(2)+"</em>");
                    }
                    break;
                case 'use-money':
                    if(confirmedMoneyAppliedAmount<=0){
                        $('.use-money-display').html('');
                        $('.confirmedMoneyAppliedAmount-display').text('<{$lang->not_applied}>');
                    }else{
                        $('.use-money-display').html("<{$lang->wallet}>:<em>-"+confirmedMoneyAppliedAmount.toFixed(2)+"</em>");
                        $('.confirmedMoneyAppliedAmount-display').text(confirmedMoneyAppliedAmount.toFixed(2));
                    }
                    $('.money-loading').html("<{$lang->available_fund}>:" + ($('#amountApply').data('available-amount') - confirmedMoneyAppliedAmount).toFixed(2));
                    $('#amountApply').val(confirmedMoneyAppliedAmount.toFixed(2));
                    break;
                case 'surcharge':
                    if(surchargevalue<=0){
                        $('.surcharge-display').html('');
                         $('.total-before-surcharge').html('');
                    }else if(currentPaymentMethod&&currentPaymentMethod!='offline'){
                      
                       $('.total-before-surcharge').html( "<span >Sub Total<em>"+grandTotal_beforeSurcharge.toFixed(2)+"</em></span>");

                        $('.surcharge-display').html(currentPaymentMethod+" surcharge("+(surchargeRate[currentPaymentMethod]*100).toFixed(2)+"%):<em>+"+ surchargevalue.toFixed(2)+"</em>");
                    }
                    break;
                case 'quantity':
                    $('.shopping-cart-item-qty').each(function(){
                        $('.checkout-confirmation-qty[data-id="'+$(this).data('id')+'"]').val($(this).val());
                    });
                    break;
            }
        }

        function refresh(){
            calculateTotal();
            calculateBookingFee();
            calculateSurcharge();
            calculateDeliverFee();
            calculatePromotion();
            calculateGrandTotal();
            updataDisplay('total');
            updataDisplay('grand-total');
            updataDisplay('booking-fee');
            updataDisplay('deliver-fee');
            updataDisplay('personal-info');
            updataDisplay('promotion-code');
            updataDisplay('use-money');
            updataDisplay('surcharge');
            updataDisplay('quantity');
            updateFormData();
        }

        function updateFormData(){
            $('#total_amount').val(total); 
            $('#booking_total').val(bookingFee); 
            $('#delivery_fee').val(deliverFee); 
            $('#promotion_total').val(promotion_amount); 
            $('#promotion_id').val(promotion_id); 
            $('#confirmedMoneyAppliedAmount').val(confirmedMoneyAppliedAmount); 
            $('#total_amount_inc_delivery_fees').val(grandTotal.toFixed(2)); 

            if(currentPaymentMethod&&currentPaymentMethod!='offline')
              $('#surcharge').val(surchargevalue); 
            else
              $('#surcharge').val(0); 

        }

        $(function(){
            $('input#firstname,input#lastname').on('keyup',function(){
                $('.name-display').text($('input#firstname').val()+" "+$('input#lastname').val());
            })
            $('input#phone').on('keyup',function(){
                 $('.phone-display').text($('input#phone').val());
            })
        });

        $(function(){

           //暂时处理： 如果商家配送，则自动选择配送
            <{if $business_delivery_info.deliver_enable}>

                $('.deliver-option-display').text( '<{$lang->business_deliver}>');
                deliverFeeEnable=true;
                updateDeliverFee();
                $('.delivery-des').show();
                $('.pickup-des').hide();
                pickupAndDeliverExceptionCheck('deliver');
             //   refresh();
            <{/if}>

            $('input[name="payment"]').click(function(){
                var selected = $('input[name="payment"]:checked');

                var target = selected.val();

                if (target == 'creditcard' && creditcardFirstTimeBuyerLimit()) {
                  alert('新用户首次购买信用卡支付上限为$100');
                  $(this).prop("checked", false);
                   $('.'+target+'-payment-des').hide();
                  currentPaymentMethod='';
                  refresh();
                  return false;
                }
                $('.payment-option-display').text(selected.data('text'));

                $('.payment-option-desc').hide();

                $('.'+target+'-payment-des').show();

                currentPaymentMethod=target;

                refresh();
            });

            function creditcardFirstTimeBuyerLimit() {
              let limit = 100;
              let isFirstTime = '<{$isFirstTimeBuyer}>';

              return ((grandTotal + confirmedMoneyAppliedAmount) > limit && isFirstTime);
            }


            <{if $lastOrderPaymentMethod}>
              $('input[name="payment"][value="<{$lastOrderPaymentMethod}>"]').prop('checked',true).trigger( "click" );
              refresh(); 
            <{/if}>

            $('input[name="deliver_option"]').click(function(){
               var selected = $('input[name="deliver_option"]:checked');
               var selectval = selected.val();

                $('.deliver-option-display').text(selected.data('text'));



                if(selectval=='1'){
                    //console.log('<{$lang->business_deliver}>');
                    deliverFeeEnable=true;
                    updateDeliverFee();
                    $('.delivery-des').show();
                    $('.pickup-des').hide();
                     pickupAndDeliverExceptionCheck('deliver');
					 refresh();
                }

                if(selectval=='2'){
                    //console.log('<{$lang->self_pickup}>');
                    deliverFeeEnable=false;

                    $('.delivery-des').hide();
                    $('.pickup-des').show();
                    pickupAndDeliverExceptionCheck('pickup');
					 refresh();
                }
            });

            if($('input[name="deliver_option"]').length==1)$('input[name="deliver_option"]').attr('checked','true').trigger( "click" );

        });

    </script>

     <script type="text/javascript">
         $(function(){
          $('.mixed-business-select').on('change',function(){
             var busienssId = $(this).find('option:selected').val();
             if(busienssId!=0)window.location.href="<{$http_root_www}>member/showcart?business_userid="+busienssId;
          })
         })
      </script>

    <script type="text/javascript">
         function pickupAndDeliverExceptionCheck($type) {
            if($type=='pickup'){
               $('.pickupAndDeliverExceptionCheck').each(function(){
                if($(this).data('type')=='realproduct'){
                  if($(this).data('pickup-avaliable')=='0'){
                    $(this).data('item-id');
                    var msg = "<span style='color:#f30'><{$lang->no_support_pickup}></span>"
                    $(this).html(msg);
                  }else{
                    var selected_staff_id = $('.pickup-list option:selected').val();
                    var supported_staff_id = $(this).data('sales-user-list');

                    selected_staff_id=selected_staff_id.toString();
                    supported_staff_id=supported_staff_id.toString();

                    var res = supported_staff_id.split(",");

                    $result = res.indexOf(selected_staff_id);

                    if($result<0){
                      var msg = "<span style='color:#f30'><{$lang->no_support_pickup}></span>"
                      $(this).html(msg);
                    }else{
                      $(this).html(" ");
                    }
                  }
                }else{
                   $(this).html("Evoucher");
                }
                })
            }else if($type=='deliver'){
               $('.pickupAndDeliverExceptionCheck').each(function(){
                if($(this).data('type')=='realproduct'){
                   if($(this).data('deliver-avaliable')=='0'){
                    $(this).data('item-id');
                    var msg = "<span style='color:#f30'><{$lang->no_support_delivery}></span>"
                    $(this).html(msg);
                  }else{
                    $(this).html(" ");
                  }
                }else{
                  $(this).html("Evoucher");
                }
                })
            }
        }
    </script>

    <script type="text/javascript">

     function update_temp_carts(){
           var data={};
          $('.minusBtn').each(function(key,value){
            var qty= $(value).next('input').val();
            var id = $(value).next('input').data('id');
            data[id]=qty;
          });

           data = JSON.stringify(data);

           $.ajax({
           url:'<{$http_root_www}>query?cmd=update_carts',
           method :'POST',
           dataType:'json',
           data:{data:data}}
            ).always(function(){
              //点击去结算，数量更新后需要重新计算运费和验证折扣码
              updateDeliverFee();
              check_promotion_code();
            }); 

      }

        $(document).ready(function() {
            $('.minusBtn').click(function(){
                var _val = $(this).next('input').val()*1 - 1;
                if( _val > 1 ){
                    $(this).removeClass('disabled').next('input').val(_val);
                }else if( _val = 1 ){
                    $(this).addClass('disabled').next('input').val(_val);
                }else{
                    $(this).addClass('disabled');
                }
                refresh();
            });

            $('.plusBtn').click(function(){
                var _val = $(this).prev('input').val()*1 + 1;
				
				
				var max_val= $(this).prev('.shopping-cart-item-qty').data('limit-qty');
				if(max_val ==0) {
				max_val=999999;
				}
			
			var main_coupon_id = $(this).prev('.shopping-cart-item-qty').data('maincouponid');
			var sub_coupon_id = $(this).prev('.shopping-cart-item-qty').data('subid');
			//alert(main_coupon_id + ' ' + sub_coupon_id);
			// 如果是子卡不检查
			if((main_coupon_id != sub_coupon_id) && sub_coupon_id>0) {

      }else{
  			if (_val>max_val) {
  			   _val =max_val;
  			   htmlMessage('<{$lang->max_quantity}>'+max_val+'!'); 
  			 }
			 }
			
          $(this).prev('input').val(_val);
          $(this).prev('input').prev('.minusBtn').removeClass('disabled');
          refresh();
          });

        });

        //提交订单后如果信息不全会弹出补全窗口。此时点击确认将直接提交订单；
        var readyToDirectlyResubmit=false;

        $(function(){
            refresh();

            $('#go-checkout-btn').on('click', function(){
                var mixedItemFromBusinesses = '<{$mixedItemFromBusinesses}>';
                if(mixedItemFromBusinesses=='true'){
                    $('.mixed-business-popup').show();

                }else{
                    $('.shopping-cart').hide();
                    $('.checkout-confirmation').show();
                     update_temp_carts();
                }
            });

            $('.go-back-btn').on('click',function(){
                if($(this).hasClass('disabled'))return;
                if($('.checkout-confirmation').is(":visible")){
                    $('.shopping-cart').show();
                    $('.checkout-confirmation').hide();
                }else{
                     window.history.back();
                }

            });

            $('.personal-info-btn').on('click',function(event) {
                $('.personal-info-sec').toggle(200);
                readyToDirectlyResubmit=false;
            });

            $('.payment-option-btn').on('click',function(event) {
                $('.payment-option-sec').toggle(200);
                readyToDirectlyResubmit=false;
            });

            $('.deliver-option-btn').on('click',function(event) {
                $('.deliver-option-sec').toggle(200);
                readyToDirectlyResubmit=false;
            });

            $('.coupon-option-btn').on('click',function(event) {
                $('.coupon-option').addClass('open');
                $('.pop-bg').show();
            });

            $('.use-money-btn').on('click',function(event) {
                $('.use-money-option').addClass('open');
                $('.pop-bg').show();
            });

            $('.pop-bg').on('click',function(event) {
                $('.pop-spec').removeClass('open');
                $('.pop-bg').hide();
                refresh();
            });

            $('.spec-close,.spec-btn').on('click',function(event) {
                $(this).parent('.pop-spec').removeClass('open');
                $('.pop-bg').hide();
                refresh();
            });

            $('.personal-info-confirm-btn').on('click',function(event) {
                if(readyToDirectlyResubmit)$(".ajaxFormSubmitBtn").trigger('click');
            });

            $('.delivery_info_list_select').on('change',function(){
                populateAddress($(this).find(':selected'));
                refresh();
            });

            if($('.delivery_info_list_select option').length<=1){
                //没有地址
                $target = $('.delivery_info_list_select option').first();
                $target.attr('selected','selected');
                populateAddress($target);
                refresh();
            }else{
               //有地址
               if($('.delivery_info_list_select option.defaultAddress').length==0){
                $target = $('.delivery_info_list_select option:not(".new")').first();
                $target.attr('selected','selected');
                populateAddress($target);
                refresh();

              }else{
                  $target=$('.delivery_info_list_select option.defaultAddress').first();
                  $target.attr('selected','selected');
                  populateAddress($target);
                  refresh();
              }
            }

            function populateAddress(target) {
               if($(target).hasClass('new')){
                    $('input#firstname').val('<{$loginUser.person_first_name}>');
                    $('input#lastname').val('<{$loginUser.person_last_name}>');
                    $('input#phone').val('<{$loginUser.phone}>');
                    $('input#email').val('<{$loginUser.email}>');
                    $('input#address').val('<{$loginUser.address}>');
                    $('input#id_number').val(' ');
					$('input#Street_number').val(' ');
					$(".addr_house_number").css('display','none'); 
					$(".addr_street").css('display','none'); 
					$(".addr_city").css('display','none'); 
					$(".addr_state").css('display','none'); 
					$(".addr_country").css('display','none'); 
					$(".addr_post_code").css('display','none'); 
					$(".addr_hint99").css('display','none'); 
					$(".Street_number").css('display','none'); 
									
                }else{
                    $('input#firstname').val($(target).data('first-name'));
                    $('input#lastname').val($(target).data('last-name'));
                    $('input#phone').val($(target).data('phone'));
                    $('input#email').val($(target).data('email'));
                    $('input#address').val($(target).data('address'));
                    $('input#id_number').val($(target).data('id-number'));
					//alert($(target).data('street_number'));
					//$('input#addr_house_number').css("display","");
					$('input#Street_number').val($(target).data('street_number'));
                }
                $('#address').trigger('geocode');
            }
        })
    </script>

    <script src="<{$SKIN_PATH}>mobile/js/jquery.mobile-events.js"></script>
    <script>
    $(function(){
        $('.m-cart li').on('swipeleft', function(e) { 
            $(this).find('.content').addClass('open');
        });
        $('.m-cart li').on('swiperight', function(e) { 
            $(this).find('.content').removeClass('open');
        });

        $('.item-remove-btn').on('click',function(e){
            $(this).parents('.content').addClass('open');
            e.stopPropagation();
        })
        $('body').on('click',function(e){
            $('.content').removeClass('open');
        })
    })
        
    </script>

    <script type="text/javascript">
        function getTimeRemaining(endtime){
          var locktimer = 20*60*1000// 20mins
          var t =endtime+locktimer-Date.now();
          var seconds = Math.floor( (t/1000) % 60 );
          var minutes = Math.floor( (t/1000/60) % 60 );
          var hours = Math.floor( (t/(1000*60*60)) % 24 );
          var days = Math.floor( t/(1000*60*60*24) );
          return {
            'total': t,
            'days': days,
            'hours': hours,
            'minutes': minutes,
            'seconds': seconds
          };
        }

        function initializeClock(obj, endtime){
          var clock = obj.get(0);//jeuqry to DOM obj
          
          var timeinterval = setInterval(function(){
            var t = getTimeRemaining(endtime);
            if(t.total<0){
                clock.innerHTML =  'Expired' ;
                clock.style.color='red';
                window.location.href=obj.data('action-url');
            }else if(t.total<60000){
                 clock.innerHTML =  t.minutes + ':' +t.seconds +'<small style="color:orange;font-size:12px">(到期自动删除)</small>';
                
            }else{
                clock.innerHTML =  t.minutes + ':' +t.seconds;
            }
            if(t.total<=0){
              clearInterval(timeinterval);
            }
          },1000);
        }

        $(function(){
            $('.countdownclock').each(function(){
                var endtime = $(this).data('endtime') *1000;
                initializeClock($(this), endtime);
            });

        });
    </script>
    <script type="text/javascript">
        var confirmedMoneyAppliedAmount=0;

        function applyPocketMoney(){

            var vTotal = total + deliverFee + bookingFee - promotion_amount ;

            var availableAmount= parseFloat($('#amountApply').data('available-amount'));
            var amountApply = parseFloat($('#amountApply').val());

            if(availableAmount>0 && amountApply>0){
                if((availableAmount>=amountApply) && (vTotal>=amountApply)){
                    confirmedMoneyAppliedAmount=amountApply;
                    $('.use-money-error').html(bootstrapAlertHtml('成功使用$'+confirmedMoneyAppliedAmount.toFixed(2),'success'));
                }else if(availableAmount<amountApply){
                    //console.log('not enough money to use');
                    confirmedMoneyAppliedAmount=0;
                    $('.use-money-error').html(bootstrapAlertHtml('你看起来没有足够的零钱哦','warning'));
                   
                }else if(vTotal<amountApply){
                    //console.log('the money applied is more than grand total');
                    $('.use-money-error').html(bootstrapAlertHtml('$'+amountApply+'太多了,只需要$'+vTotal+'就够了！'));
                    confirmedMoneyAppliedAmount=vTotal;
                    amountApply = vTotal;
                }
            }else if(amountApply==0){
                confirmedMoneyAppliedAmount=0;
            }else{
                //console.log('input error');
            }
            refresh();
        }
    </script>


    <script type="text/javascript">
        function bootstrapAlertHtml(msg,type){
            var html ='<div class="alert alert-'+type+' alert-dismissible" role="alert" >';
            html +='<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
            html +=msg;
            html +='</div>';
            return html;
        }
    </script>
    <script type="text/javascript">

        var promotion_amount=0;
        var promotion_id;
        var promotion_code;
        var promotion_des;

        // 检查是否输入正确的兑换码
       function check_promotion_code() {
            var code = $('#promotion_code').val();
			//alert(code);
            var total_cart_amount=$('#checkout-confirmation-total').text();
           
            if(!code)return;
            
            $.ajax({
              method:"GET",
              url: "<{$http_root_www}>company/check_promotion_code",
              data:{pcode:code,businessUserId:'<{$businessUser.id}>',total_cart_amount1:total_cart_amount},
              beforeSend: function( xhr ) {
                    $('.promotion-loading').html("<i class='fa fa-cog fa-spin fa-lg' style='color:#39BF21'></i> Processing...");
              }
            })
              .done(function( data ) {
                data = jQuery.parseJSON(data);
                if(data.status){
                    //code match
                    promotion_amount=parseFloat(data.promotion_amount);
                    promotion_id=data.promotion_id;
                    promotion_des=data.promotion_des;

                    $('.promotion-loading').html(data.msg);
                    $('#verified_image').css('display','');

                }else{
                    promotion_amount=0;
                    promotion_id=0;
                    promotion_des=0;

                    $('.promotion-loading').html(data.msg);
                    $('#verified_image').css('display','none');
                }
               
              })
              .always(function(){
                refresh();
              })
        }
    </script>

    <script type="text/javascript">
        function saveAddress() {
             updateDeliverFee();

             var firstname=$('input#firstname').val();
			
			 //如果street_number 本身不为空，则取该值，否则自动存储 google分出来的门票号码
 			 var  addr_house_number=$('input#Street_number').val();
			 if (!addr_house_number) {
			   addr_house_number = $('input#addr_house_number').val();
			 }
			
             var lastname=$('input#lastname').val();
             var phone=$('input#phone').val();
             var email=$('input#email').val();
             var address=$('input#address').val();
             var id_number=$('input#id_number').val();
             var id=$(".delivery_info_list_select option:selected").data('id');
             var url="";

             if(!firstname&&!lastname&&!phone&&!email&&!address)return;

             if (id==null||id==''||id=='undefined')
             {
                 url = '<{$http_root_www}>query?cmd=saveAddress&firstname='+firstname+'&lastname='+lastname+'&addr_house_number='+addr_house_number+'&phone='+phone+'&email='+email+'&address='+address+'&id_number='+id_number+'&type=0';
             }
             else
             {
                 url = '<{$http_root_www}>query?cmd=saveAddress&firstname='+firstname+'&lastname='+lastname+'&addr_house_number='+addr_house_number+'&phone='+phone+'&email='+email+'&address='+address+'&id_number='+id_number+'&type='+id+'';
             }

             $.ajax({
                 url:url,
                 method:"GET",
                 success:function(data){
                     $(".delivery_info_list_select option:selected").data('id',data);
                 },
             });
         }
    </script>

   
   <script type="text/javascript">
       // this is the id of the form
        $(function(){

        var ajaxFormSubmit=false;

        $(".ajaxFormSubmitBtn").on('click',function(event) {

            if(ajaxFormSubmit)return false;
            
            saveAddress();
               normalSubmit();

        });

        })

        function normalSubmit(){
              $.ajax({
                   method: $('.ajaxForm').attr('method'),
                   url: $('.ajaxForm').attr('action'),
                   data: $('.ajaxForm').serialize(), 
                   cache: false,
                   dataType: "text",
                   beforeSend: function( xhr ) {
                            ajaxFormSubmit= true;
                            $('.ajaxFormResponse').remove();
                            $('.ajaxForm').before("<div class='ajaxFormResponse'></div>");

                            $('.ajaxFormResponse').html("<i class='fa fa-cog fa-spin fa-lg' style='color:#39BF21'></i> Processing");
                      },
                   success: function(data)
                   {  
                       try{
                          data = jQuery.parseJSON(data);
                       }catch(err){
                          $('.ajaxFormResponse').html('<{$lang->alert_network_problems}>');
                          return;
                       }

                       if(data.status==200){
                         $('.ajaxFormResponse').html(data.msg);
                          setTimeout(function(){
                            window.location.href = data.redirect.replace('&amp;', '&');
                          }, 1000);
                       }else{
                         $('.ajaxFormResponse').html(data.msg);

                         data.status=data.status+"";

                          $('.personal-info-sec').hide();
                          $('.payment-option-sec').hide();
                          $('.deliver-option-sec').hide();

                          if(data.status.indexOf(501)>=0){
                            $('.personal-info-sec').show();
                          }

                          if(data.status.indexOf(502)>=0){
                            $('.payment-option-sec').show();
                          }

                          if(data.status.indexOf(503)>=0){
                            $('.deliver-option-sec').show();
                          }
                       }

                       $('.ajaxFormResponse').on('click',function(){
                          $(this).remove();
                        }).delay(4000).fadeOut(500);

                       readyToDirectlyResubmit=true;//点击弹出窗口的确认按钮直接检出

                   }
                }).always(function(){
                    ajaxFormSubmit= false;
                });
        }

        function hcashSubmit(){
             if(!timer){
                  alert('汇率已经失效，请重新刷新获得最新汇率后再次提交');
                  return false;
              }

              var hcashRate =$('input[name="hcashRate"]').val();
              var hcashAmount=$('input[name="hcashAmount"]').val();
              var hcashOrderTag =$('input[name="hcashOrderTag"]').val();
              var hcashOrderId =$('input[name="hcashOrderId"]').val();
              
              if(!hcashRate||!hcashAmount){
                  alert('还没有获得汇率和hcash价格');
                  return false;
              }

              // if(!hcashOrderTag||!hcashOrderId){
              //     alert('请填写正确的转账信息');
              //     return false;
              // }

              $('.hcash-pay-box').hide();

              normalSubmit();
        }

   </script>

    <script type="text/javascript">
        //special checkout action; 
        $(function(){
            var specialCheckout = '<{$specialCheckout}>';
            var errormsg = '<{$ERRORMSG}>';
            
            if(specialCheckout!='NONE' && specialCheckout!='ERROR'){
                $('#go-checkout-btn').click();
                // $('.go-back-btn').addClass('disabled');
                $('#promotion_code').val(specialCheckout);
                check_promotion_code();
            }
        })
    </script>

      <script type="text/javascript">
          $('.hcashRefreshBtn').on('click',function(){
            if(seconds>0)return;
            timerStart();
             $.get("<{$http_root_www}>query?cmd=hcash_rate",function(data){

                var data = $.parseJSON(data.trim());

                var hcashRate = parseFloat(data.hsr_rate);
                var aud_to_cny = parseFloat(data.aud_to_cny);


                var cnyPrice=aud_to_cny*grandTotal;
                var hcashRate=hcashRate.toFixed(8);
                var hcashAmount=(grandTotal*hcashRate).toFixed(2);

                $('.cnyPrice').html(cnyPrice.toFixed(2));
                $('.hcashRate').html(hcashRate);
                $('.hcashAmount').html(hcashAmount + " HSR");

                $('input[name="hcashRate"]').val(hcashRate);
                $('input[name="hcashAmount"]').val(hcashAmount);
                // alert('success');
             }).done(function(){
                // alert('second success');
             }).fail(function(){
                // alert('error ');
             }).always(function(){
                // alert('finished');
             })
          });


          var seconds=0;
          var timer;
          function timerFunction() {
            if(seconds <= 300) { // I want it to say 1:00, not 60
              $('.timer').html(seconds +"s");
            }

            if (seconds >0 ) { // so it doesn't go to -1
               seconds--;
            } else {
               clearInterval(timer);
               timer=0;
               $('.timer').html(' ');
               $('.hcashRefreshBtn').css('background-color',"#29b729");
                $('.hcashRefreshText').html("<{$lang->refresh_exchange_rate}>");
            }
          }

           function timerStart() {
            seconds=300;
            $('.hcashRefreshBtn').css('background-color',"#aaa");
            $('.hcashRefreshText').html("<{$lang->exchange_rate_lock}>");

            if(!timer) {
              timer =setInterval(function() { 
                timerFunction();
              }, 1000); 
            }
          } 
      </script>

      <script type="text/javascript">
         $(function(){
          if($(location).attr('hash')=='#directCheckout'){
             $('#go-checkout-btn').trigger('click');
             console.log('directCheckout');
          }
         })
      </script>

    <script>
        new Vue({
            el:"#order",
            data:{
                code:'',
                isLanguageEn:1,
                isUse:false,
                isUsePop:false,
                isPop:false,
                isDatePop:false,  // 日期弹出框
                isUpdateAddress:false,
                isaddAddress:false,
                currentDeliveryAddressFirstName:'',
                currentDeliveryAddressLastName:'',
                currentDeliveryAddress:'',
                currentDeliveryAddressPhone:'',
                newFirstName:'',
                newLastName:'',
                newPhone:'',
                newAddress:'',
                newOther:'',
                newEmail:'',
                orderTimeAndDeliveryTime:[
                ],
                businessDispSchedule:[],



            },
            mounted:function(){
                this.currentDeliveryAddress='<{$delivery_info.address}>';
                this.currentDeliveryAddressPhone='<{$delivery_info.phone}>';
                this.currentDeliveryAddressFirstName ='<{$delivery_info.first_name}>';
                this.currentDeliveryAddressLastName='<{$delivery_info.last_name}>';



                //获取商家关于该客户的下单及配送时间的文字表述；
                this.orderTimeAndDeliveryTime=JSON.parse('<{$current_business_tuangou_time}>');

                // 获得当前客户可以下单的日期列表显示，
                this.businessDispSchedule=JSON.parse('<{$businessDispSchedule}>');

                //设置默认的配送日期
                this.selectDefaultDeliveryDate();
                console.log(this.businessDispSchedule);

                console.log( this.orderTimeAndDeliveryTime);

               console.log('ispopdate value is :' +this.isDatePop);



            },
            methods:{
                next:function(){
                    window.location.href="orderPage/orderSuccess.htm"
                },
                datePop:function(){
                    this.isDatePop=true
                },
                closePop:function(source){
                    if(source=='c'){  // 购物车
                        this.iscartPop=false
                    }else if(source=='d'){
                        this.isDatePop=false
                    }else{
                        this.isPop=false
                    }
                },
                // 设置某个日期为配送日期，用户点击选择
                selectDeliveryDate:function(index){
                    // 清除所有的 select 标志
                    var arrlength =this.businessDispSchedule.length;
                    for (let i = 0; i < arrlength; i++) {
                        this.businessDispSchedule[i].isselected =0;
                    }

                    //设置当前的标志为 select
                    this.businessDispSchedule[index].isselected =1;
                    this.selectDateIndex =index;


                    this.setCookie("deliveryDateIndex",index,1);
                    //系统解析选择日期时用了一个特殊符号@，符号前是日期的unix 数字，后面是 morning afternoon ,anytime ,这里暂时设置为anytime .
                    let datetime = this.businessDispSchedule[index].orderDeliveryTimestamp +'@anytime';
                    this.setCookie("DispCenterUserSelectedDeliveryDate",datetime,1);


                    console.log('index is' + index);
                    console.log('the setting cookie index is :' + this.getCookie('deliveryDateIndex'));
                    console.log('the setting cookie DispCenterUserSelectedDeliveryDate is :' + this.getCookie('DispCenterUserSelectedDeliveryDate'));

                },
                // 设置默认配送日期
                selectDefaultDeliveryDate:function(){
                    // 清除所有的 select 标志
                    var i =this.getCookie('deliveryDateIndex');
                    //	console.log('cookie index is :' +i );

                    if(i) {
                        this.selectDateIndex =i;
                        //设置日期数组的对应index 为 isselected
                        this.businessDispSchedule[i].isselected=1;
                        console.log('find in cookie index is  :' +i);
                        return 1;

                    }

                    var arrlength =this.businessDispSchedule.length;
                    for (let i = 0; i < arrlength; i++) {
                        if(this.businessDispSchedule[i].isAvaliable) {
                            this.businessDispSchedule[i].isselected =1;
                            this.selectDateIndex =i;
                            this.setCookie("deliveryDateIndex",i,1);


                            console.log('cam not find coolie,generate by default' + this.getCookie('deliveryDateIndex'));


                            //	this.DeiveryDate=this.businessDispSchedule[i].disPlayDate + ' ' + this.businessDispSchedule[i].days;
                            break;
                        }



                    }
                },
                changeDate:function(){
                    this.isPop=true
                },


                returnPage:function(){
                    window.history.go(-1)
                },




                close(){
                    this.isUsePop=false
                },
                sure(){
                    this.isUse=true
                    this.isUsePop=false
                },
                setCookie:function (cname,cvalue,exdays){
                    var d = new Date();
                    d.setTime(d.getTime()+(exdays*24*60*60*1000));
                    var expires = "expires="+d.toGMTString();
                    //	document.cookie =cname + "=";
                    document.cookie = cname+"="+cvalue+" ; "+expires + " ; path=/;";
                },
                getCookie:function (cname){
                    var name = cname + "=";
                    var ca = document.cookie.split(';');
                    for(var i=0; i<ca.length; i++) {
                        var c = ca[i].trim();
                        if (c.indexOf(name)==0) { return c.substring(name.length,c.length); }
                    }
                    return "";
                }
            }
        })
    </script>
</body>
</html>